<!DOCTYPE html><html lang="en" class="h-full" data-astro-cid-j7pv25f6> <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>evalla - Safe math evaluator</title><meta name="description" content="Safe math evaluator with variables, dependencies, and precision"><meta property="og:title" content="evalla - Safe math evaluator"><meta property="og:description" content="Safe math evaluator with variables, dependencies, and precision"><meta property="og:type" content="website"><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Borel&display=swap" rel="stylesheet"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css"><link rel="stylesheet" href="_astro/index.D3ET6C67.css">
<style>.content h1{display:none}.content h2{color:#2563eb;font-size:1.875rem;margin-top:2.5rem;margin-bottom:1rem;border-bottom:2px solid #e5e7eb;padding-bottom:.5rem}.content h3{color:#374151;font-size:1.5rem;margin-top:2rem;margin-bottom:.75rem}.content h4{color:#4b5563;font-size:1.25rem;margin-top:1.5rem;margin-bottom:.5rem}.content p{margin-bottom:1rem;line-height:1.75;color:#374151}.content ul,.content ol{margin-bottom:1rem;margin-left:2rem}.content li{margin-bottom:.5rem;line-height:1.75;color:#374151}.content code{background:#f3f4f6;padding:.2rem .4rem;border-radius:.25rem;font-family:ui-monospace,monospace;font-size:.9em;color:#2563eb}.content pre{background:#f8f9fa;color:#1f2937;padding:1.5rem;border:1px solid #e5e7eb;border-radius:.5rem;overflow-x:auto;margin:1.5rem 0}.content pre code{background:none;padding:0;color:inherit;font-size:.875rem;line-height:1.5}.content pre code.hljs{background:none;padding:0}.content a{color:#2563eb;text-decoration:none;border-bottom:1px solid transparent;transition:border-color .2s}.content a:hover{border-bottom-color:#2563eb}.content strong{color:#1f2937;font-weight:600}body{background-color:#f3f4f6;background-image:radial-gradient(circle,#d1d5db 1px,transparent 1px);background-size:20px 20px}
</style></head> <body class="min-h-screen flex flex-col" data-astro-cid-j7pv25f6> <header class="bg-white border-b border-gray-200"> <div class="container mx-auto px-4 py-3"> <div class="flex items-center justify-between flex-wrap gap-3"> <div class="flex items-baseline gap-3"> <a href="#" class="font-borel text-2xl sm:text-3xl font-bold text-blue-600 hover:text-blue-700 transition-colors no-underline">
evalla
</a> <span class="hidden sm:inline text-gray-600 text-sm">Safe math evaluator</span> </div> <nav class="flex items-center gap-2 sm:gap-3">  <a href="./playground" class="px-3 py-1.5 text-sm text-gray-600 hover:text-blue-600 transition-colors">
Playground
</a> <a href="https://github.com/danmarshall/evalla" target="_blank" rel="noopener noreferrer" class="px-3 py-1.5 text-sm text-gray-600 hover:text-blue-600 transition-colors flex items-center gap-1.5" aria-label="GitHub"> <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"> <path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path> </svg> <span class="hidden sm:inline">GitHub</span> </a> </nav> </div> </div> </header> <main class="flex-1 container mx-auto px-4 sm:px-6 py-6 sm:py-8 max-w-5xl" data-astro-cid-j7pv25f6> <div class="bg-white rounded-lg shadow-lg p-4 sm:p-6 md:p-8" data-astro-cid-j7pv25f6> <!-- Auto-generated by sync-readme.js - DO NOT EDIT MANUALLY --><div class="content"><h1>evalla</h1>
<p>Safe math evaluator with variables, dependencies, and precision.</p>
<pre><code class="language-typescript">import { evalla } from &#39;evalla&#39;;

const result = await evalla([
  { name: &#39;a&#39;, expr: &#39;c + 5&#39; },          // depends on c
  { name: &#39;b&#39;, expr: &#39;a * 2&#39; },          // depends on a
  { name: &#39;c&#39;, expr: &#39;1 + 1&#39; }           // base constant
]);

console.log(result.values.a.toString()); // &quot;7&quot;
console.log(result.values.b.toString()); // &quot;14&quot;
console.log(result.values.c.toString()); // &quot;2&quot;
console.log(result.order);               // [&#39;c&#39;, &#39;a&#39;, &#39;b&#39;]
</code></pre>
<h2>Features</h2>
<ul>
<li>✅ <strong>Decimal Precision</strong>: Uses <a href="https://mikemcl.github.io/decimal.js/">decimal.js</a> internally for accurate arithmetic</li>
<li>✅ <strong>Variable References</strong>: Support dependencies between expressions</li>
<li>✅ <strong>Dot-Traversal</strong>: Reference nested properties (e.g., <code>point.x</code>, <code>offset.y</code>)</li>
<li>✅ <strong>Topological Ordering</strong>: Evaluates in correct dependency order (DAG)</li>
<li>✅ <strong>Circular Detection</strong>: Throws error on circular dependencies</li>
<li>✅ <strong>Safe Evaluation</strong>: Parses with <a href="https://peggyjs.org/">Peggy</a> parser, evaluates AST (no <code>eval()</code> or <code>Function()</code>)</li>
<li>✅ <strong>Keywords as Variables</strong>: Unlike JavaScript, keywords like <code>return</code>, <code>if</code>, etc. can be used as variable names</li>
<li>✅ <a href="#namespaces"><strong>Namespaces</strong></a>: Built-in <code>$math</code>, <code>$unit</code>, and <code>$angle</code> functions</li>
</ul>
<h2>Installation</h2>
<pre><code class="language-bash">npm install evalla
</code></pre>
<h3>Input Format</h3>
<pre><code class="language-typescript">interface ExpressionInput {
  name: string;         // Variable name (cannot start with $)
  expr?: string;        // Math expression (optional if value is provided)
  value?: any;          // Direct value (optional if expr is provided)
}
</code></pre>
<p>You must provide either <code>expr</code> or <code>value</code> per item. The <code>value</code> property allows you to pass objects directly without stringifying them into expressions.</p>
<p><strong>Using expressions:</strong></p>
<pre><code class="language-typescript">const result = await evalla([
  { name: &#39;width&#39;, expr: &#39;100&#39; },
  { name: &#39;height&#39;, expr: &#39;50&#39; }
]);
</code></pre>
<p><strong>Using direct values:</strong></p>
<pre><code class="language-typescript">const result = await evalla([
  { name: &#39;point&#39;, value: { x: 10, y: 20 } },
  { name: &#39;offset&#39;, value: { x: 5, y: 10 } }
]);
</code></pre>
<p><strong>Mixing both:</strong></p>
<pre><code class="language-typescript">const result = await evalla([
  { name: &#39;data&#39;, value: { width: 100, height: 50 } },
  { name: &#39;area&#39;, expr: &#39;data.width * data.height&#39; }
]);
</code></pre>
<h3>Output Format</h3>
<pre><code class="language-typescript">interface EvaluationResult {
  values: Record&lt;string, Decimal&gt;;  // Computed values as Decimal objects
  order: string[];                  // Evaluation order (topologically sorted)
}
</code></pre>
<h2>Examples</h2>
<h3>Basic Arithmetic with Precision</h3>
<pre><code class="language-typescript">const result = await evalla([
  { name: &#39;x&#39;, expr: &#39;0.1 + 0.2&#39; }
]);

console.log(result.values.x.toString()); // &quot;0.3&quot; (exact!)
</code></pre>
<h3>Variable Dependencies</h3>
<pre><code class="language-typescript">const result = await evalla([
  { name: &#39;d&#39;, expr: &#39;c * 2&#39; },
  { name: &#39;b&#39;, expr: &#39;a + 10&#39; },
  { name: &#39;c&#39;, expr: &#39;b * 3&#39; },
  { name: &#39;a&#39;, expr: &#39;5&#39; }
]);

// Automatically orders: a, b, c, d
console.log(result.order); // [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;]
console.log(result.values.d.toString()); // &quot;90&quot;
</code></pre>
<h3>Dot-Traversal with Object Literals</h3>
<p>Variable names must be simple identifiers (no dots), but expressions can use object literals and dot-notation:</p>
<pre><code class="language-typescript">const result = await evalla([
  { name: &#39;point&#39;, expr: &#39;{x: 10, y: 20}&#39; },
  { name: &#39;offset&#39;, expr: &#39;{x: 5, y: 10}&#39; },
  { name: &#39;resultX&#39;, expr: &#39;point.x + offset.x&#39; },
  { name: &#39;resultY&#39;, expr: &#39;point.y + offset.y&#39; }
]);

console.log(result.values.resultX.toString()); // &quot;15&quot;
console.log(result.values.resultY.toString()); // &quot;25&quot;
</code></pre>
<h3>Nested Property Access</h3>
<pre><code class="language-typescript">const result = await evalla([
  { name: &#39;data&#39;, expr: &#39;{pos: {x: 5, y: 10}, scale: 2}&#39; },
  { name: &#39;scaledX&#39;, expr: &#39;data.pos.x * data.scale&#39; }
]);

console.log(result.values.scaledX.toString()); // &quot;10&quot;
</code></pre>
<h3>Namespaces</h3>
<p>Variables may not begin with $, this is reserved for namespaces for built-in functions and constants.</p>
<h4>$math Namespace</h4>
<p>Mathematical constants and functions:</p>
<pre><code class="language-typescript">const result = await evalla([
  { name: &#39;circumference&#39;, expr: &#39;2 * $math.PI * 10&#39; },
  { name: &#39;absVal&#39;, expr: &#39;$math.abs(-42)&#39; },
  { name: &#39;sqrtVal&#39;, expr: &#39;$math.sqrt(16)&#39; },
  { name: &#39;maxVal&#39;, expr: &#39;$math.max(10, 5, 20, 3)&#39; }
]);
</code></pre>
<p><strong>Available:</strong></p>
<ul>
<li>Constants: <code>PI</code>, <code>E</code>, <code>SQRT2</code>, <code>SQRT1_2</code>, <code>LN2</code>, <code>LN10</code>, <code>LOG2E</code>, <code>LOG10E</code></li>
<li>Functions: <code>abs</code>, <code>sqrt</code>, <code>cbrt</code>, <code>floor</code>, <code>ceil</code>, <code>round</code>, <code>trunc</code>, <code>sin</code>, <code>cos</code>, <code>tan</code>, <code>asin</code>, <code>acos</code>, <code>atan</code>, <code>atan2</code>, <code>exp</code>, <code>ln</code>, <code>log</code>, <code>log10</code>, <code>log2</code>, <code>pow</code>, <code>min</code>, <code>max</code></li>
</ul>
<h4>$unit Namespace</h4>
<p>Unit conversion functions:</p>
<pre><code class="language-typescript">const result = await evalla([
  { name: &#39;inches&#39;, expr: &#39;$unit.mmToInch(25.4)&#39; },
  { name: &#39;mm&#39;, expr: &#39;$unit.inchToMm(1)&#39; }
]);
</code></pre>
<p><strong>Available:</strong></p>
<ul>
<li><code>mmToInch</code>, <code>inchToMm</code></li>
<li><code>cmToInch</code>, <code>inchToCm</code></li>
<li><code>mToFt</code>, <code>ftToM</code></li>
</ul>
<h4>$angle Namespace</h4>
<p>Angle conversion functions:</p>
<pre><code class="language-typescript">const result = await evalla([
  { name: &#39;radians&#39;, expr: &#39;$angle.toRad(180)&#39; },
  { name: &#39;degrees&#39;, expr: &#39;$angle.toDeg($math.PI)&#39; }
]);
</code></pre>
<p><strong>Available:</strong></p>
<ul>
<li><code>toRad</code> (degrees to radians)</li>
<li><code>toDeg</code> (radians to degrees)</li>
</ul>
<h3>Circular Dependency Detection</h3>
<pre><code class="language-typescript">try {
  await evalla([
    { name: &#39;a&#39;, expr: &#39;b + 1&#39; },
    { name: &#39;b&#39;, expr: &#39;a + 1&#39; }
  ]);
} catch (error) {
  console.log(error.message); // &quot;Circular dependency detected: b -&gt; a -&gt; b&quot;
}
</code></pre>
<h3>Variable naming</h3>
<p>Variables may not begin with a number, double underscore(__), or $ (see namespaces above).</p>
<h4>Keywords as Variable Names</h4>
<p>Unlike JavaScript, algebra-like variable names can include JavaScript keywords:</p>
<pre><code class="language-typescript">const result = await evalla([
  { name: &#39;return&#39;, expr: &#39;10&#39; },
  { name: &#39;if&#39;, expr: &#39;20&#39; },
  { name: &#39;for&#39;, expr: &#39;return + if&#39; }
]);

console.log(result.values.for.toString()); // &quot;30&quot;
</code></pre>
<h2>Security</h2>
<p><strong>Safe by design:</strong></p>
<ul>
<li>❌ No access to <code>eval()</code>, <code>Function()</code>, or other dangerous globals</li>
<li>❌ No access to <code>process</code>, <code>require</code>, or Node.js internals</li>
<li>❌ No access to dangerous properties: <code>prototype</code>, <code>__proto__</code>, <code>constructor</code>, or any property starting with <code>__</code></li>
<li>✅ Only whitelisted functions in namespaces</li>
<li>✅ Uses AST parsing (Peggy) + safe evaluation</li>
<li>✅ Variable names cannot start with <code>$</code> (reserved for system)</li>
<li>✅ Sandboxed scope with <code>Object.create(null)</code></li>
<li>✅ No prototype pollution</li>
</ul>
<p><strong>Blocked property access examples:</strong></p>
<pre><code class="language-typescript">// These will throw SecurityError
await evalla([{ name: &#39;bad&#39;, expr: &#39;obj.prototype&#39; }]);
await evalla([{ name: &#39;bad&#39;, expr: &#39;obj.__proto__&#39; }]);
await evalla([{ name: &#39;bad&#39;, expr: &#39;obj.constructor&#39; }]);
await evalla([{ name: &#39;bad&#39;, expr: &#39;obj.__defineGetter__&#39; }]);
</code></pre>
<p>Properties starting with <code>__</code> are blocked because they typically provide access to JavaScript internals that could be exploited for prototype pollution or other security vulnerabilities.</p>
<h2>API</h2>
<h3><code>evalla(inputs: ExpressionInput[]): Promise&lt;EvaluationResult&gt;</code></h3>
<p>Evaluates an array of math expressions with dependencies.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>inputs</code>: Array of <code>{ name, expr }</code> objects</li>
</ul>
<p><strong>Returns:</strong></p>
<ul>
<li>Promise resolving to <code>{ values, order }</code></li>
</ul>
<p><strong>Throws:</strong></p>
<ul>
<li><code>ValidationError</code> - Invalid input (missing name, duplicate names, invalid variable names)<ul>
<li>Properties: <code>variableName</code></li>
</ul>
</li>
<li><code>CircularDependencyError</code> - Circular dependencies detected<ul>
<li>Properties: <code>cycle</code> (array of variable names in the cycle)</li>
</ul>
</li>
<li><code>ParseError</code> - Syntax/parsing errors in expressions (extends <code>EvaluationError</code>)<ul>
<li>Properties: <code>variableName</code>, <code>expression</code>, <code>line</code>, <code>column</code></li>
</ul>
</li>
<li><code>EvaluationError</code> - Runtime evaluation errors (undefined variables, type errors)<ul>
<li>Properties: <code>variableName</code></li>
</ul>
</li>
<li><code>SecurityError</code> - Attempt to access blocked properties (prototype, <strong>proto</strong>, constructor, __*)<ul>
<li>Properties: <code>property</code></li>
</ul>
</li>
</ul>
<p>All errors include structured details for programmatic access - no need to parse error messages!</p>
<p><strong>Error Handling:</strong></p>
<pre><code class="language-typescript">import { evalla, ParseError, SecurityError, CircularDependencyError, ValidationError, EvaluationError } from &#39;evalla&#39;;

try {
  const result = await evalla(inputs);
} catch (error) {
  // Catch ParseError first since it extends EvaluationError
  if (error instanceof ParseError) {
    console.error(`Syntax error in &quot;${error.variableName}&quot; at ${error.line}:${error.column}`);
    console.error(`Expression: ${error.expression}`);
  } else if (error instanceof EvaluationError) {
    console.error(`Runtime error in &quot;${error.variableName}&quot;`);
  } else if (error instanceof SecurityError) {
    console.error(`Security violation: attempted to access &quot;${error.property}&quot;`);
  } else if (error instanceof CircularDependencyError) {
    console.error(`Circular dependency: ${error.cycle.join(&#39; -&gt; &#39;)}`);
  } else if (error instanceof ValidationError) {
    console.error(`Invalid variable: &quot;${error.variableName}&quot;`);
  }
}
</code></pre>
<h3><code>checkSyntax(expr: string): SyntaxCheckResult</code></h3>
<p>Checks the syntax of an expression without evaluating it. Useful for text editors to validate expressions before sending them for evaluation.</p>
<p><strong>Parameters:</strong></p>
<ul>
<li><code>expr</code>: The expression string to check</li>
</ul>
<p><strong>Returns:</strong></p>
<ul>
<li>Object with the following properties:<ul>
<li><code>valid</code>: boolean - Whether the syntax is valid</li>
<li><code>error?</code>: string - Error message if syntax is invalid</li>
<li><code>line?</code>: number - Line number where error occurred (1-indexed)</li>
<li><code>column?</code>: number - Column number where error occurred (1-indexed)</li>
</ul>
</li>
</ul>
<p><strong>Example:</strong></p>
<pre><code class="language-typescript">import { checkSyntax } from &#39;evalla&#39;;

// Valid expression
const result1 = checkSyntax(&#39;a + b * 2&#39;);
console.log(result1.valid); // true

// Invalid expression - missing closing parenthesis
const result2 = checkSyntax(&#39;(a + b&#39;);
console.log(result2.valid); // false
console.log(result2.error); // &quot;Parse error at line 1, column 7: Expected...&quot;
console.log(result2.line); // 1
console.log(result2.column); // 7
</code></pre>
<p><strong>Usage Patterns:</strong></p>
<p>When to use <code>checkSyntax()</code> vs just calling <code>evalla()</code>:</p>
<pre><code class="language-typescript">import { checkSyntax, evalla, EvaluationError } from &#39;evalla&#39;;

// Pattern 1: Pre-validate for immediate user feedback (recommended for text editors/UI)
const inputs = [
  { name: &#39;a&#39;, expr: &#39;c + 5&#39; },
  { name: &#39;b&#39;, expr: &#39;a * 2&#39; }
];

// Check syntax of each expression before calling evalla
for (const input of inputs) {
  if (input.expr) {
    const check = checkSyntax(input.expr);
    if (!check.valid) {
      console.error(`Invalid syntax in &quot;${input.name}&quot;: ${check.error}`);
      return; // Don&#39;t call evalla with invalid syntax
    }
  }
}

// All syntax valid, now evaluate
const result = await evalla(inputs);

// Pattern 2: Let evalla handle all validation (simpler for batch processing)
try {
  const result = await evalla(inputs);
  // Success - use result
} catch (error) {
  // Catch ParseError specifically to handle syntax errors
  if (error instanceof ParseError) {
    console.error(`Syntax error in &quot;${error.variableName}&quot; at ${error.line}:${error.column}`);
  } else if (error instanceof EvaluationError) {
    console.error(&#39;Runtime evaluation error:&#39;, error.message);
  }
  // Handle other error types (ValidationError, CircularDependencyError, etc.)
}
</code></pre>
<p><strong>Note:</strong> </p>
<ul>
<li><code>checkSyntax()</code> only validates expression syntax. It does not check variable names, detect circular dependencies, or validate that referenced variables exist.</li>
<li><code>evalla()</code> throws <code>ParseError</code> for syntax errors with the same details (line, column, message) as <code>checkSyntax()</code>, plus identifies which variable has the error.</li>
<li><code>ParseError</code> extends <code>EvaluationError</code>, so catch <code>ParseError</code> first if you want to handle syntax errors differently from runtime errors.</li>
<li>Use <code>checkSyntax()</code> for pre-flight validation (e.g., real-time feedback as user types). Use <code>evalla()</code> for complete validation and evaluation.</li>
</ul>
<h2>Philosophy</h2>
<ul>
<li><strong>Minimal</strong>: Bare minimum dependencies and code</li>
<li><strong>Modular</strong>: Separated concerns (parser, evaluator, namespaces, toposort)</li>
<li><strong>DRY</strong>: No code duplication</li>
<li><strong>Testable</strong>: Small, focused functions with clear interfaces</li>
<li><strong>Safe &amp; Secure</strong>: No arbitrary code execution, whitelist-only approach</li>
<li><strong>Efficient</strong>: Parse once, use for both dependency extraction and evaluation</li>
</ul>
<h2>Development</h2>
<pre><code class="language-bash"># Install dependencies
npm install

# Build
npm run build

# Test
npm test
</code></pre>
<p>For detailed API documentation and examples, see the sections above.</p>
<h2>License</h2>
<p>MIT</p>
</div> </div> </main> <footer class="bg-white border-t border-gray-200 text-gray-600 text-sm mt-auto"> <div class="container mx-auto px-4 py-4"> <div class="flex flex-col sm:flex-row items-center justify-between gap-2"> <div class="text-center sm:text-left">
© 2024 evalla. MIT License.
</div> <div class="flex items-center gap-4"> <a href="https://github.com/danmarshall/evalla" target="_blank" rel="noopener noreferrer" class="hover:text-blue-600 transition-colors">
Documentation
</a> <a href="https://github.com/danmarshall/evalla/issues" target="_blank" rel="noopener noreferrer" class="hover:text-blue-600 transition-colors">
Issues
</a> </div> </div> </div> </footer> </body></html>